[supervisord]
nodaemon=true
user=root

# Proceso 1: La API de Node.js (El "Recepcionista")
# Inicia tu server.js para que escuche las órdenes de actualización
[program:node-api]
command=node server.js
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# Proceso 2: FFmpeg (El "Músico")
[program:ffmpeg]
# ¡Aquí está tu comando original!
# Lee el 'playlist.txt' local y lo repite infinitamente.
# Solo se reiniciará cuando 'node-api' (server.js) reciba una orden.
command=bash -c "sleep 5 && \
    ffmpeg -re -f concat -safe 0 \
    -protocol_whitelist file,http,https,tcp,tls \
    -i /usr/src/app/playlist.txt \
    -stream_loop -1 \
    -c:a aac -b:a 128k -ar 44100 -ac 2 \
    -f flv \"$RTMP_URL\""
autorestart=true
startretries=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# Configuración para permitir que 'server.js' controle este proceso
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=http://127.0.0.1:9001